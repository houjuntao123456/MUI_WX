<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../mui/css/mui.css">
    <link rel="stylesheet" href="../css/wx_chat2.css">
    <link rel="stylesheet" href="../css/chat_iconfont.css">
    <script src="../mui/js/mui.js"></script>
    <script src="../js/vconsole.js"></script>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/TB.js"></script>
    <!-- <script src="../js/jquery.qq_min.js"></script>
    <script src="../js/jquery.qqFace2.js"></script> -->
    <script src="../js/jquery.cookie.js"></script>

    <title>聊天</title>
    <style>
        .question,
        .answer {
            margin-bottom: 1rem;
        }

        .question {
            text-align: right;
        }

        .question>div {
            display: inline-block;
        }

        .answer>div {
            display: inline-block;
        }

        .left {
            float: left;
            position: relative;
        }

        .right {
            float: right;
            position: relative;
        }

        .clear {
            clear: both;
        }

        .heard_img {
            height: 50px;
            width: 50px;
            border-radius: 5px;
            overflow: hidden;
            background: #ddd;
            margin-right: 5px;
        }

        .heard_img img {
            width: 100%;
            height: 100%
        }

        .heard_huida {
            height: 50px;
            width: 50px;
            border-radius: 5px;
            overflow: hidden;
            background: #ddd;
            margin-left: 5px;
        }

        .heard_huida img {
            width: 100%;
            height: 100%
        }

        .question_text,
        .answer_text {
            box-sizing: border-box;
            position: relative;
            display: table-cell;
            min-height: 60px;
        }

        .question_text {
            padding-right: 14px;
        }

        .answer_text {
            padding-left: 15px;
        }

        .question_text p,
        .answer_text p {
            border-radius: 10px;
            padding: .5rem;
            margin: 0;
            font-size: 14px;
            line-height: 28px;
            box-sizing: border-box;
            vertical-align: middle;
            display: table-cell;
            height: 60px;
            word-wrap: break-word;
        }

        .answer_text p {
            background: #fff;
            color: black;
        }

        .question_text p {
            background: #9EEA6A;
            color: black;
            text-align: left;
        }

        .question_text i,
        .answer_text i {
            width: 0;
            height: 0;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            position: absolute;
            top: 19px;
        }

        .answer_text i {
            border-right: 10px solid #fff;
            left: 5px;
        }

        .question_text i {
            border-left: 10px solid #9EEA6A;
            right: 5px;
        }

        /* 
    
    
    */
        #content_chat {
            position: fixed;
            left: 0px;
            right: 0px;
            bottom: 50px;
            /* overflow: hidden; */
        }

        .question_Name {
            position: absolute;
            top: 50px;
            right: 8px;
            font-size: 12px;
        }

        .answer_Name {
            position: absolute;
            top: 50px;
            left: 10px;
            font-size: 12px;
        }

        .display {
            display: none;
        }

        .picture_div {
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            position: fixed;
            z-index: 1;
            top: 0px;
        }
    </style>
</head>

<body>
    <!-- <header class="mui-bar mui-bar-nav">
            <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
            <h1 class="mui-title">chat (聊天窗口)</h1>
        </header> -->
    <!-- 内容 -->
    <div class="picture_div display" id="picture_div">
        <div style="width: 90%;margin: 0 auto;margin-top:100px;overflow-y: scroll; height: 70%;">
            <img id="picture_div_img" src="" alt="" width="100%">
        </div>
    </div>
    <div class="mui-content" id="content_chat">
        <br>
        <!-- <button onclick="kop()">暂停</button> -->
        <!-- 反馈收到数据框 -->
        <!-- <div class="answer">
            <div class="left">
                <div class="heard_huida">
                    <img src="../images/account.png">
                </div>
                <div class="answer_Name">东皇太一</div>
            </div>
            <div class="answer_text clear" style="max-width: 70%;">
                <p>您发送的文字是：撒地方阿斯蒂芬按撒地方按时发放假回家吧爱好的说法艾灸短竖符号阿达是否姐姐sad大家回复;暗黑风大立科技暗黑风时</p>
                <i></i>
            </div>
        </div> -->

        <!-- 提出发送的数据 -->
        <!-- <div class="question">
            <div class="right">
                <div class="heard_img">
                    <img src="../images/up.png">
                </div>
                <div class="question_Name">东皇太一</div>
            </div>
            <div class="question_text clear" style="max-width: 70%;">
                <p><img src="../arclist/46.gif" border="0" />
                    三方科技空间即可连接空间就看见看见看见看见了看见骷髅精灵看见了看见了看见了看见家家户户炬华科技第三方科技空间即可连接空间就看见看见看见看见了看见骷髅精灵看见了看见了看见了看见
                </p>
                <i></i>
            </div>
        </div> -->

    </div>
    <!-- 底部 -->
    <footer id="footer_bottom">
        <section id="section_bottom">
            <div class="footer-left">
                <i id='msg-mic' class="iconfont icon-yuyin" style="display: none;"></i>
                <i id='msg-bars' class="iconfont icon-jianpan" style="display: none;"></i>
            </div>
            <div class="footer-center">
                <textarea id='msg-text' type="text" class='input-text' name="msg-text" style="overflow-y:visible;"></textarea>
                <button id='msg-sound' type="button" class='input-sound' style="display: none;">按住说话</button>
            </div>
            <div for="" class="footer-right">
                <i id='msg-pengyouquan' class="iconfont icon-xiaolian"></i>&nbsp;
                <i id='msg-image' class="iconfont icon-jiahao"></i>
                <button id='msg-send' type="button" class="mui-btn mui-btn-success"
                    style="padding: 4px 5px 4px 5px;position: relative;bottom: 5px; display: none;">发送</button>
            </div>
        </section>
        <!-- 表情容器 -->
        <section id="section_bq" class="display" style="background-color: #fafafa;">
            <table border="0" id="facebox" cellspacing="0" cellpadding="0" style="width:100%;">
                <tr>
                    <td style="width:10%;"><img src="../arclist/1.gif" value="[/::)]" /></td>
                    <td style="width:10%;"><img src="../arclist/2.gif" value="[/::~]" /></td>
                    <td style="width:10%;"><img src="../arclist/3.gif" value="[/::B]" /></td>
                    <td style="width:10%;"><img src="../arclist/4.gif" value="[/::|]" /></td>
                    <td style="width:10%;"><img src="../arclist/5.gif" value="[/::<]" /></td>
                    <td style="width:10%;"><img src="../arclist/6.gif" value="[/::$]" /></td>
                    <td style="width:10%;"><img src="../arclist/7.gif" value="[/::X]" /></td>
                    <td style="width:10%;"><img src="../arclist/8.gif" value="[/::Z]" /></td>
                    <td style="width:10%;"><img src="../arclist/9.gif" value="[/::'(]" /></td>
                    <td style="width:10%;"><img src="../arclist/10.gif" value="[/::-|]" /></td>
                </tr>
                <tr>
                    <td style="width:10%;"><img src="../arclist/11.gif" value="[/::@]" /></td>
                    <td style="width:10%;"><img src="../arclist/12.gif" value="[/::P]" /></td>
                    <td style="width:10%;"><img src="../arclist/13.gif" value="[/::D]" /></td>
                    <td style="width:10%;"><img src="../arclist/14.gif" value="[/::O]" /></td>
                    <td style="width:10%;"><img src="../arclist/15.gif" value="[/::(]" /></td>
                    <td style="width:10%;"><img src="../arclist/16.gif" value="[Blush]" /></td>
                    <td style="width:10%;"><img src="../arclist/17.gif" value="[/::Q]" /></td>
                    <td style="width:10%;"><img src="../arclist/18.gif" value="[/::T]" /></td>
                    <td style="width:10%;"><img src="../arclist/19.gif" value="[/:,@P]" /></td>
                    <td style="width:10%;"><img src="../arclist/20.gif" value="[/:,@-D]" /></td>
                </tr>
                <tr>
                    <td style="width:10%;"><img src="../arclist/21.gif" value="[/::d]" /></td>
                    <td style="width:10%;"><img src="../arclist/22.gif" value="[/:,@o]" /></td>
                    <td style="width:10%;"><img src="../arclist/23.gif" value="[/::g]" /></td>
                    <td style="width:10%;"><img src="../arclist/24.gif" value="[/:|-)]" /></td>
                    <td style="width:10%;"><img src="../arclist/25.gif" value="[/::!]" /></td>
                    <td style="width:10%;"><img src="../arclist/26.gif" value="[/::L]" /></td>
                    <td style="width:10%;"><img src="../arclist/27.gif" value="[/::>]" /></td>
                    <td style="width:10%;"><img src="../arclist/28.gif" value="[/::,@]" /></td>
                    <td style="width:10%;"><img src="../arclist/29.gif" value="[/:,@f]" /></td>
                    <td style="width:10%;"><img src="../arclist/30.gif" value="[/::-S]" /></td>
                </tr>
                <tr>
                    <td style="width:10%;"><img src="../arclist/31.gif" value="[/:?]" /></td>
                    <td style="width:10%;"><img src="../arclist/32.gif" value="[/:,@x]" /></td>
                    <td style="width:10%;"><img src="../arclist/33.gif" value="[/:,@@]" /></td>
                    <td style="width:10%;"><img src="../arclist/34.gif" value="[/::8]" /></td>
                    <td style="width:10%;"><img src="../arclist/35.gif" value="[/:,@!]" /></td>
                    <td style="width:10%;"><img src="../arclist/36.gif" value="[/:xx]" /></td>
                    <td style="width:10%;"><img src="../arclist/37.gif" value="[/:bye]" /></td>
                    <td style="width:10%;"><img src="../arclist/38.gif" value="[/:wipe]" /></td>
                    <td style="width:10%;"><img src="../arclist/39.gif" value="[/:dig]" /></td>
                    <td style="width:10%;"><img src="../arclist/40.gif" value="[/:&-(]" /></td>
                </tr>
                <tr>
                    <td style="width:10%;"><img src="../arclist/41.gif" value="[/:B-)]" /></td>
                    <td style="width:10%;"><img src="../arclist/42.gif" value="[/:<@]" /></td>
                    <td style="width:10%;"><img src="../arclist/43.gif" value="[/:@>]" /></td>
                    <td style="width:10%;"><img src="../arclist/44.gif" value="[/::-O]" /></td>
                    <td style="width:10%;"><img src="../arclist/45.gif" value="[/:>-|]" /></td>
                    <td style="width:10%;"><img src="../arclist/46.gif" value="[/:P-(]" /></td>
                    <td style="width:10%;"><img src="../arclist/47.gif" value="[/::'|]" /></td>
                    <td style="width:10%;"><img src="../arclist/48.gif" value="[/:X-)]" /></td>
                    <td style="width:10%;"><img src="../arclist/49.gif" value="[/::*]" /></td>
                    <td style="width:10%;"><img src="../arclist/50.gif" value="[/:@x]" /></td>
                </tr>
                <tr>
                    <td style="width:10%;"><img src="../arclist/51.gif" value="[/:8*]" /></td>
                    <td style="width:10%;"><img src="../arclist/52.gif" value="[/:hug]" /></td>
                    <td style="width:10%;"><img src="../arclist/53.gif" value="[/:moon]" /></td>
                    <td style="width:10%;"><img src="../arclist/54.gif" value="[/:sun]" /></td>
                    <td style="width:10%;"><img src="../arclist/55.gif" value="[/:bome]" /></td>
                    <td style="width:10%;"><img src="../arclist/56.gif" value="[/:!!!]" /></td>
                    <td style="width:10%;"><img src="../arclist/57.gif" value="[/:pd]" /></td>
                    <td style="width:10%;"><img src="../arclist/58.gif" value="[/:pig]" /></td>
                    <td style="width:10%;"><img src="../arclist/59.gif" value="[/:<W>]" /></td>
                    <td style="width:10%;"><img src="../arclist/60.gif" value="[/:coffee]" /></td>
                </tr>
                <tr>
                    <td style="width:10%;"><img src="../arclist/61.gif" value="[/:eat]" /></td>
                    <td style="width:10%;"><img src="../arclist/62.gif" value="[/:heart]" /></td>
                    <td style="width:10%;"><img src="../arclist/63.gif" value="[/:strong]" /></td>
                    <td style="width:10%;"><img src="../arclist/64.gif" value="[/:weak]" /></td>
                    <td style="width:10%;"><img src="../arclist/65.gif" value="[/:share]" /></td>
                    <td style="width:10%;"><img src="../arclist/66.gif" value="[/:v]" /></td>
                    <td style="width:10%;"><img src="../arclist/67.gif" value="[/:@)]" /></td>
                    <td style="width:10%;"><img src="../arclist/68.gif" value="[/:jj]" /></td>
                    <td style="width:10%;"><img src="../arclist/69.gif" value="[/:ok]" /></td>
                    <td style="width:10%;"><img src="../arclist/70.gif" value="[/:no]" /></td>
                </tr>
                <tr>
                    <td style="width:10%;"><img src="../arclist/71.gif" value="[/:rose]" /></td>
                    <td style="width:10%;"><img src="../arclist/72.gif" value="[/:fade]" /></td>
                    <td style="width:10%;"><img src="../arclist/73.gif" value="[/:showlove]" /></td>
                    <td style="width:10%;"><img src="../arclist/74.gif" value="[/:love]" /></td>
                    <td style="width:10%;"><img src="../arclist/75.gif" value="[/:<L>]" /></td>
                </tr>
            </table>
        </section>

    </footer>



    <!-- 发送图片 -->
    <div id="img_sheet2" class="mui-popover mui-popover-bottom mui-popover-action ">
        <input type="file" accept="image/*" multiple id="upload_picture" style="display: none;"
            onchange="uploadImageHandle(this,0.5)">
        <ul class="mui-table-view">
            <li class="mui-table-view-cell">
                <a href="#img_sheet2" style="text-align: left;color: #8f8f94; font-size: 14px;">发送图片<span
                        class="mui-icon mui-icon-closeempty" style=" float: right;"></span></a>
            </li>
        </ul>
        <!-- 可选择菜单 -->
        <ul class="mui-table-view">
            <li class="mui-table-view-cell">
                <!-- <textarea name="" cols="30" rows="5" id="add_text" style="color: black;"></textarea> -->
                <img id="img__show" src="../images/2.jpg" alt="" width="80%">
            </li>
        </ul>
        <!-- 立即添加 -->
        <ul class="mui-table-view">
            <li class="mui-table-view-cell add_beizhu">
                <b onclick="send_true()">确定发送</b>
            </li>
        </ul>
    </div>

    <script>

        // 发送图片
        var send_image = document.getElementById("msg-image");
        var picture_src = "";
        // 图片上传
        mui("#msg-image")[0].addEventListener("tap", function () {
            $('#upload_picture').click();
            // 清空图片储存
            base64_YS = "";
            // 清空文件储存
            file_File = "";
            // 清除图片路径
            picture_src = "";
        });
        function send_true() {
            var data = new FormData();
            data.append('code', code);
            data.append('model', 'weixin');
            data.append('file', file_File);
            // data.append('img_txt', mui("#text_area")[0].value);
            $.ajax({
                data: data,
                type: "POST",
                url: '/index.php/UserlistWxSendOutImage/',
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    mui('#img_sheet2').popover('toggle');
                    if (data.code == 400) {
                        mui.toast(data.msg, {
                            duration: 'long',
                            type: 'div'
                        })
                    } else {
                        //将内容显示到界面上
                        Question_data_images_voice('<img class="Answer_data_img" src="' + base64_YS + '" alt="" width="150px">');
                    }
                },
                error: function (xhr) {
                    mui.toast('照片选择失败,请重新选择!', {
                        duration: 'long',
                        type: 'div'
                    });
                }
            }, 'JSON');
        }

        // 上传图片
        function show_picture() {
            document.getElementById("img__show").setAttribute("src", base64_YS);
            mui('#img_sheet2').popover('show');
        }
        // 图片压缩
        var file_File = ""; //接收file变量
        var base64_YS = "";//接收压缩的base64编码
        function uploadImageHandle(File_domain, Multiple) {
            // 创建实例
            var reader = new FileReader();
            var img = document.createElement('img');
            // 读取上传的图片的信息(lastModified, lastModifiedDate, name, size, type等)
            var file = File_domain.files[0];
            // 记下上传的图片的name, 后面会用到
            var flieName = File_domain.files[0].name;
            // 记下上传的图片的类型, 后面会用到
            var fileType = file.type;
            // 生成canvas画布
            var canvas = document.createElement('canvas');
            var context = canvas.getContext('2d');
            // MDN: 该方法会读取指定的 Blob 或 File 对象。读取操作完成的时候，
            // readyState 会变成已完成（DONE），并触发 loadend 事件，
            // 同时 result 属性将包含一个data:URL格式的字符串（base64编码）以表示所读取文件的内容。
            // 也就是说, 将File对象转化为base64位字符串
            reader.readAsDataURL(file);
            // 上一步是异步操作, 读取完成后会执行onload事件, 而base64的字符串在e.target.rusult中
            reader.onload = function (e) {
                // 获得图片dom
                var base64 = e.target.result
                img.src = base64;
                //  console.log(base64.length+ base64);
                //   create_content(789, '的暑假', base64);
            };

            img.onload = function () {
                // 图片原始尺寸
                var originWidth = this.width;
                var originHeight = this.height;

                // 最大尺寸限制
                var maxWidth = this.width * Multiple,
                    maxHeight = this.height * Multiple;
                // 目标尺寸
                var targetWidth = originWidth,
                    targetHeight = originHeight;
                // 图片尺寸超过800x800的限制
                if (originWidth > maxWidth || originHeight > maxHeight) {
                    if (originWidth / originHeight > maxWidth / maxHeight) {
                        // 更宽，按照宽度限定尺寸
                        targetWidth = maxWidth;
                        targetHeight = Math.round(
                            maxWidth * (originHeight / originWidth)
                        );
                    } else {
                        targetHeight = maxHeight;
                        targetWidth = Math.round(
                            maxHeight * (originWidth / originHeight)
                        );
                    }
                }
                // canvas对图片进行缩放
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                // 清除画布
                context.clearRect(0, 0, targetWidth, targetHeight);
                // 将图片划到canvas上
                context.drawImage(img, 0, 0, targetWidth, targetHeight);
                // 把canvas转成base64格式并去除头
                var base64 = canvas
                    .toDataURL(fileType)
                // .replace(/^data:image\/(jpeg|jpg|png|gif);base64,/, '');
                base64_YS = base64;
                file_File = base_flie(base64, flieName);

                // });
                show_picture();
            };


        }


        function base_flie(dataurl, filename) {//将base64转换为文件
            var arr = dataurl.split(',');
            var mime = arr[0].match(/:(.*?);/)[1];
            var bstr = atob(arr[1]);
            var n = bstr.length;
            var u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, { type: mime });
        }

    </script>

</body>
<script>
    // 点击笑脸按钮显示图标列表
    document.getElementById("msg-pengyouquan").onclick = function () {
        close_TB();
    }
    //点击图标触发的事件
    mui("#facebox").on('tap', 'img', function () {
        mui("#msg-send")[0].style.display = "";
        mui("#msg-image")[0].style.display = "none";
        // 获取id
        var value = this.getAttribute("value");
        // 文本框内容
        document.getElementById("msg-text").value = document.getElementById("msg-text").value + code_name(value);
        close_TB();

    })
    //开关表情
    function close_TB() {
        if (document.getElementById("section_bq").classList.contains("display")) {
            document.getElementById("section_bq").classList.remove('display');
        } else {
            document.getElementById("section_bq").classList.add('display');
            $('#content_chat')[0].style.bottom = "50px";
            $('#content_chat')[0].style.paddingTop = "50px";
        }
    }

    // 时间日期转化
    var time_data = [];
    function add_time_data(Time) {
        time_data.push(Time);
        // <p style="text-align: center;">2018-12-09</p>
        // console.log( time_data[time_data.length - 1]+600);
        if (time_data.length == 1) {
            var p = document.createElement("p") //创造节点
            p.style = "text-align: center;";
            p.innerHTML = timeConvert(time_data[0], 1)
            content_chat.appendChild(p);
        }

        if (time_data[time_data.length - 2] + 600 < Time) {
            var p = document.createElement("p") //创造节点
            p.style = "text-align: center;";
            p.innerHTML = timeConvert(Time, 1)
            content_chat.appendChild(p);
        }



    }
    function timeConvert(timestamp, num) {//num:0 YYYY-MM-DD  num:1  YYYY-MM-DD hh:mm:ss // timestamp:时间戳 
        timestamp = timestamp + '';
        timestamp = timestamp.length == 10 ? timestamp * 1000 : timestamp;
        var date = new Date(timestamp);
        var y = date.getFullYear();
        var m = date.getMonth() + 1;
        m = m < 10 ? ('0' + m) : m;
        var d = date.getDate();
        d = d < 10 ? ('0' + d) : d;
        var h = date.getHours();
        h = h < 10 ? ('0' + h) : h;
        var minute = date.getMinutes();
        var second = date.getSeconds();
        minute = minute < 10 ? ('0' + minute) : minute;
        second = second < 10 ? ('0' + second) : second;
        if (num == 0) {
            return y + '-' + m + '-' + d;
        } else {
            return y + '-' + m + '-' + d + ' ' + h + ':' + minute + ':' + second;
        }
    }


    // 截取[]间的内容
    function code_name(str) {
        str = str.substring(str.indexOf("[") + 1, str.indexOf("]"))
        return str;
    }

    String.prototype.replaceAll = function (s1, s2) {
        return this.replace(new RegExp(s1, "gm"), s2);
    }

    function escapeRegExp(str) {
        return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
    }
    function replace_em(str) {
        for (let x = 0; x < TB.length; x++) {
            // str += i;
            str = str.replaceAll(escapeRegExp(TB[x].icon), '<img src="' + TB[x].image + '" border="0"/>');
        }
        return str;
    }

    // 获取数据和将数据显示到对话框
</script>

</script>
<script>
    var hd = window.parent.document.getElementById("nav");
    hd.style.display = "none";
    var hh = window.parent.document.getElementsByClassName("mui-iframe-wrapper");
    hh[0].style.bottom = "0px";


    // var loc = location.href;
    // var n1 = loc.length;
    // var n2 = loc.indexOf('=');
    // var code = decodeURI(loc.substr(n2 + 1, n1 - n2));

    var loc = location.href;
    var n1 = loc.length;
    var n2 = loc.indexOf('=');
    var n3 = loc.indexOf('*');
    var code = decodeURI(loc.substr(n2 + 1, n3 - n2 - 7));
    var secrp = decodeURI(loc.substr(n3 + 1, n1 - n3));
    var photo_picture = "";
    var username = ""
    window.onload = function () {
        photo();
        zidong();
    }
    // 根据卡号查会员头像
    function photo() {
        mui.post('/index.php/UserlistMemberdata/', {
            code: code,
        }, function (data) {
            if (data.code == 200) {
                username = data.data.data[0].username;
                if (data.data.data[0].img == " " || data.data.data[0].img == "") {
                    photo_picture = "../images/zw.jpg";
                } else {
                    photo_picture = data.data.data[0].img;
                }
            }
            //服务器返回响应，根据响应结果，分析是否登录成功；
        }, 'json'
        );
    }

    var time = "";
    // 获取收到的数据,将数据显示到界面(回答数据)
    var kkk = true;
    function zidong() {
        mui.post('/index.php/UserlistWxChatRecord/', {
            code: code,
            createtime: time,
            company: $.cookie("company")
        }, function (data) {
            if (data.code == 200) {
                if (data.data == "null" || data.data == null || data.data == "" || data.data == " ") {
                    // 暂无数据
                    if (secrp != "") {
                        //将数据传递到后台
                        button_send(secrp);
                        
                    }
                } else {
                    time = data.data[data.data.length - 1].createTime;
                    for (let i = 0; i < data.data.length; i++) {
                        if (data.data[i].toUser == "null" || data.data[i].toUser == null) {
                            //管理员说的话
                            if (kkk) {
                                if (data.data[i].msgType == 'image') {
                                    Question_data_images_voice('<img class="Answer_data_img" src="' + data.data[i].img + '" alt="" width="150px">');
                                } else if (data.data[i].msgType == "voice") {
                                    Question_data_images_voice('<audio id="myAudio" controls style="width:200px;"><source src="' + data.data[i].voice + '" type="audio/mp3"></audio>')
                                } else {
                                    Question_data(data.data[i].content);
                                }
                                // 时间筛选
                                if (data.data[i].content == "null" || data.data[i].content == null) {
                                } else {
                                    add_time_data(data.data[i].createTime);
                                }
                            }
                        } else {
                          
                            //用户说的话
                            if (data.data[i].msgType == 'image') {
                                // 图片
                                Answer_data_image_voice('<img class="Answer_data_img" src="' + data.data[i].img + '" alt="" width="150px">');
                            } else if (data.data[i].msgType == "voice") {
                                console.log(i)
                                // 语音
                                Answer_data_image_voice('<audio id="myAudio" controls style="width:200px;"><source src="' + data.data[i].voice + '" type="audio/mp3"></audio>')
                            } else {
                                // 文字和表情
                                Answer_data(data.data[i].content);
                            }
                            // 时间筛选
                            if (data.data[i].content == "null" || data.data[i].content == null) {
                            } else {
                                add_time_data(data.data[i].createTime);

                            }
                        }

                    }
                    kkk = false;
                    if (secrp != "") {
                        //将数据传递到后台
                        button_send(secrp);
                        
                    }
                }

            } else if (data.code == 400) {
                mui.toast(data.msg, {
                    duration: 'long',
                    type: 'div'
                })
            }
            //服务器返回响应，根据响应结果，分析是否登录成功；
        }, 'json'
        );
    }

    $(function () {
        $("#msg-text").bind('input porpertychange', function () {
            if (this.value.length < 13) {
                mui("#section_bottom")[0].style.minHeight = '50px';
                $('#content_chat')[0].style.bottom = "50px";
                $('#content_chat')[0].style.paddingTop = "50px";
            } else if (this.value.length >= 13) {
                // section_bottom
                mui("#section_bottom")[0].style.minHeight = '70px';
                $('#content_chat')[0].style.bottom = "70px";
                $('#content_chat')[0].style.paddingTop = "70px";
            } else if (this.value.length >= 26) {
                // section_bottom
                mui("#section_bottom")[0].style.minHeight = '100px';
                $('#content_chat')[0].style.bottom = "100px";
                $('#content_chat')[0].style.paddingTop = "100px";
            } else {

            }
        });

    });
</script>

<script>
    // var vConsole = new VConsole();
    // 点击话筒图标需进行操作
    // mui("#msg-mic")[0].addEventListener("tap", function () {
    //     // 输入框隐藏,语音开启
    //     mui("#msg-text")[0].style.display = "none";
    //     mui("#msg-sound")[0].style.display = "";
    //     // 语音图标隐藏,输入图框显示
    //     mui("#msg-bars")[0].style.display = ""
    //     mui("#msg-mic")[0].style.display = "none";
    //     close();
    // });
    // 点击扩展图标需进行操作
    mui("#msg-bars")[0].addEventListener("tap", function () {
        // alert(789);
        // 输入框开启,语音隐藏
        mui("#msg-text")[0].style.display = "";
        mui("#msg-sound")[0].style.display = "none";
        // 扩展标隐藏,语音标显示
        mui("#msg-bars")[0].style.display = "none";
        mui("#msg-mic")[0].style.display = "";
    });
    // 获取焦点发送按钮显示,拍照图标隐藏
    mui("#msg-text")[0].onfocus = function () {
        mui("#msg-send")[0].style.display = "";
        mui("#msg-image")[0].style.display = "none";



    }
    //失去焦点 离开弹框如果内容无长度,则隐藏发送按钮,拍照图标显示
    mui("#msg-text")[0].onblur = function () {
        if (this.value.length == 0) {
            mui("#msg-send")[0].style.display = "none";
            mui("#msg-image")[0].style.display = "";
        }
    }
    //  发送过后,按钮隐藏,拍照图标显示,
    mui("#msg-send")[0].addEventListener("tap", function () {
        // mui("#msg-send")[0].style.display = "none";
        // mui("#msg-image")[0].style.display = "";
        // mui("#msg-text")[0].value="";
        var str = $("#msg-text").val();
        $("#msg-2").html(replace_em(str));
        //将数据传递到后台
        button_send(str);

        // 获取当前时间的时间戳
        add_time_data(Math.round(new Date() / 1000));

    })


</script>
<script>
    //按钮发送执行的操作
    function button_send(str) {
        mui("#msg-send")[0].style.display = "none";
        mui("#msg-image")[0].style.display = "";
        mui("#msg-text")[0].value = "";
        mui("#section_bottom")[0].style.minHeight = '50px';
        $('#content_chat')[0].style.bottom = "50px";
        $('#content_chat')[0].style.paddingTop = "50px";

        mui.post('/index.php/UserlistWxSendOutTxt/', {
            code: code,
            content: str
            // company: $.cookie("company")
        }, function (data) {
            //服务器返回响应，根据响应结果，分析是否登录成功；
            if (data.code == 400) {
                mui.toast(data.msg, {
                    duration: 'long',
                    type: 'div'
                })
            } else {
                //将内容显示到界面上
                Question_data(str);
            }

        }, 'json'
        );

    }
</script>
<script>
    var content_chat = document.getElementById("content_chat"); //获取内容ID
    // 获取text的数据.将数据发送到界面(提问数据)
    //自己说的话
    function Question_data(data) {
        var div = document.createElement("div") //创造节点
        div.className = "question";
        div.innerHTML = '<div class="right">'
            + '<div class="heard_img">'
            + '<img src="' + $.cookie("headImgUrl") + '">'
            + '</div>'
            + '<div class="question_Name">客服</div>'
            + '</div>'
            + '<div class="question_text clear" style="max-width: 70%;">'
            + '<p>' + replace_em(data) + '</p>'
            + '<i></i>'
            + '</div>'
        content_chat.appendChild(div);
        di();
    }

    //      图片和语音
    function Question_data_images_voice(data) {
        var div = document.createElement("div") //创造节点
        div.className = "question";
        div.innerHTML = '<div class="right">'
            + '<div class="heard_img">'
            + '<img src="' + $.cookie("headImgUrl") + '">'
            + '</div>'
            + '<div class="question_Name">客服</div>'
            + '</div>'
            + '<div class="question_text clear" style="max-width: 70%;">'
            + '<p>' + data + '</p>'
            + '<i></i>'
            + '</div>'
        content_chat.appendChild(div);
        di();
    }
  
    var timename = setInterval(function () {
        mui.post('/index.php/UserlistWxChatRecord/', {
            code: code,
            createtime: time,
            company: $.cookie("company")
        }, function (data) {
            if (data.code == 200) {
                if (data.data == "null" || data.data == null) {
                    // 暂无数据
                } else {
                    if (data.data.length == 0) {
                        // 触发
                    } else {
                        time = data.data[data.data.length - 1].createTime;
                        for (var i = 0; i < data.data.length; i++) {
                            if (data.data[i].toUser == "null" || data.data[i].toUser == null) {
                                //管理员说的话
                                if (kkk) {
                                     if (data.data[i].msgType == 'image') {
                                        Question_data_images_voice('<img class="Answer_data_img" src="' + data.data[i].img + '" alt="" width="150px">');
                                    } else if (data.data[i].msgType == "voice") {
                                        console.log(i)
                                        Question_data_images_voice('<audio id="myAudio" controls style="width:200px;"><source src="' + data.data[i].voice + '" type="audio/mp3"></audio>')
                                    } else {
                                        Question_data(data.data[i].content);
                                    }
                                    // 时间筛选
                                    if (data.data[i].content == "null" || data.data[i].content == null) {
                                    } else {
                                        add_time_data(data.data[i].createTime);
                                    }
                                }
                            } else {
                                //用户说的话
                                // Answer_data(data.data[i].content);
                                //用户说的话
                                  //用户说的话
                                if (data.data[i].msgType == 'image') {
                                    // 图片
                                    Answer_data_image_voice('<img class="Answer_data_img" src="' + data.data[i].img + '" alt="" width="150px">');
                                } else if (data.data[i].msgType == "voice") {
                                    // 语音
                                    Answer_data_image_voice('<audio id="myAudio" controls style="width:200px;"><source src="' + data.data[i].voice + '" type="audio/mp3"></audio>')
                                } else {
                                    // 文字和表情
                                    Answer_data(data.data[i].content);
                                }
                                // 时间筛选
                                if (data.data[i].content == "null" || data.data[i].content == null) {
                                } else {
                                    add_time_data(data.data[i].createTime);

                                }
                            }

                        }
                        kkk = false;

                    }
                }
            }
            //服务器返回响应，根据响应结果，分析是否登录成功；
        }, 'json'
        );
    }, 10000);

    //公众号说的话
    mui("#content_chat").on('tap', '.Answer_data_img', function () {
        document.getElementById("picture_div").classList.remove("display");
        document.getElementById("picture_div_img").src = this.src;
    })
    // 关闭图片放大图片
    document.getElementById("picture_div").onclick = function () {
        document.getElementById("picture_div").classList.add("display");
    }
    // Answer_data("天龙盖地虎,宝塔镇河妖");
    function Answer_data(data) {
        if (data == null) {
        } else {
            var div = document.createElement("div") //创造节点
            div.className = "answer";
            div.innerHTML = '<div class="left">'
                + '<div  class="heard_huida">'
                + '<img src="' + photo_picture + '">'
                + '</div>'
                + '<div class="answer_Name">' + username + '</div>'
                + '</div>'
                + '<div class="answer_text clear" style="max-width: 70%;">'
                + '<p>' + replace_em(data) + '</p>'
                + ' <i></i>'
                + '</div>'
            content_chat.appendChild(div);
        }

    }

    // 图片 , 语音
    function Answer_data_image_voice(data) {
        if (data == null) {
        } else {
            var div = document.createElement("div") //创造节点
            div.className = "answer";
            div.innerHTML = '<div class="left">'
                + '<div  class="heard_huida">'
                + '<img src="' + localStorage.getItem("data_photo") + '">'
                + '</div>'
                + '<div class="answer_Name">' + localStorage.getItem("username") + '</div>'
                + '</div>'
                + '<div class="answer_text clear" style="max-width: 70%;">'
                + '<p>' + data + '</p>'
                + ' <i></i>'
                + '</div>'
            content_chat.appendChild(div);
        }

    }

    // 苹果手机采用CSS1
    if (/iphone/i.test(navigator.userAgent)) {
        document.body.addEventListener('focusin', () => {
            //软键盘弹起事件 
            close();
            di()
        })

        document.body.addEventListener('focusout', () => {
            //软键盘关闭事件 
            document.activeElement.scrollIntoViewIfNeeded(true); // 解决苹果不回弹页面 关键
            // alert("苹果2")
        })

    }

    // // 安卓手机采用CSS2
    // // 安卓手机采用CSS2
    var winHeight = $(window).height();
    if (/android/i.test(navigator.userAgent)) {
        // alert("安卓");
        $(window).resize(function () {
            var thisHeight = $(this).height();
            if (winHeight - thisHeight > 50) {
                //窗口发生改变(大),故此时键盘弹出
                //当软键盘弹出，在这里面操作
                close();
                di()
            } else {

            }
        });

    }
    //页面滚动到底端
    function di() {
        var scrollHeight = mui('#content_chat')[0].scrollHeight;
        mui('#content_chat')[0].scrollTop = scrollHeight;
    }
    function close() {
        if (document.getElementById("section_bq").classList.contains("display") != true) {
            document.getElementById("section_bq").classList.add('display');
            $('#content_chat')[0].style.bottom = "50px";
            $('#content_chat')[0].style.paddingTop = "50px";
        }
    }




</script>

</html>