<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../../mui/css/mui.min.css">
    <link rel="stylesheet" href="../../css/iconfont.css">
    <script src="../../mui/js/muiR.js"></script>
    <script src="../../js/stm_Pull_up_loading.js"></script>
    <script src="../../js/jquery.min.js"></script>
    <script src="../../js/jquery.cookie.js"></script>
    <script src="../../js/vconsole.js"></script>

    <link rel="stylesheet" href="../../css/loading.css">
    <script src="../../js/loading.js"></script>
    <title>卡券详情</title>
</head>
<style>
    .dsplay {
        display: none;
    }
</style>

<body>
    <header class="mui-bar mui-bar-nav mui-bar-nav-bg" style="background-color:#007aff;">
        <!-- <a href="javascript:history.go(-1)" class="mui-icon mui-icon-back" style="color:white;"></a> -->
        <h1 class="mui-title" style="color:white;">卡券详情</h1>

    </header>

    <div class="mui-card" style="margin-top: 50px;">
        <!--页眉，放置标题-->
        <div class="" style="padding: 10px 15px;text-align: center;font-size: 20px;color: #EC0505;" id="card_name">
        </div>

        <!--内容区-->
        <div class="mui-card-content mui-card-media" id="bg_img" style="height:40vw;">

            <!-- <img src="../../images/2.jpg" alt=""> -->
        </div>

        <!--页脚，放置补充信息或支持的操作-->
        <div style="padding: 10px 15px">
            <!-- 卡劵类型 -->
            <div class="mui-row">
                <div class="mui-col-xs-3 mui-col-sm-3">
                    <p>卡劵类型: </p>
                </div>
                <div class="mui-col-xs-9 mui-col-sm-9">
                    <span style="color: sandybrown" id="card_type"></span>
                </div>
            </div>
            <!-- 剩余卡劵 -->
            <div class="mui-row" id="display_card">
                <div class="mui-col-xs-3 mui-col-sm-3">
                    <p>剩余卡劵: </p>
                </div>
                <div class="mui-col-xs-9 mui-col-sm-9">
                    <span style="color: sandybrown" id="card_number"></span>
                </div>
            </div>


            <!-- 卡劵金额 -->
            <div class="mui-row dsplay" id="display_card_money">
                <div class="mui-col-xs-3 mui-col-sm-3">
                    <p>卡劵金额: </p>
                </div>
                <div class="mui-col-xs-9 mui-col-sm-9">
                    <span style="color: sandybrown" id="card_money"></span>
                </div>
            </div>
            <!-- 卡劵折扣 -->
            <div class="mui-row dsplay" id="display_card_zhekou">
                <div class="mui-col-xs-3 mui-col-sm-3">
                    <p>卡劵折扣: </p>
                </div>
                <div class="mui-col-xs-9 mui-col-sm-9">
                    <span style="color: sandybrown" id="card_zhekou"></span>
                </div>
            </div>
            <!-- 礼品 -->
            <div class="mui-row dsplay" id="display_card_lipin">
                <div class="mui-col-xs-3 mui-col-sm-3">
                    <p>礼品: </p>
                </div>
                <div class="mui-col-xs-9 mui-col-sm-9">
                    <span style="color: sandybrown" id="card_lipin"></span>
                </div>
            </div>





            <!-- 适用门店 -->
            <!-- <div class="mui-row dsplay" id="display_store">
                <div class="mui-col-xs-3 mui-col-sm-3">
                    <p>适用门店: </p>
                </div>
                <div class="mui-col-xs-9 mui-col-sm-9">
                    <span style="color: sandybrown" id="card_store">唯帅</span>
                </div>
            </div> -->
            <!-- 核销门店 -->
            <div class="mui-row">
                <div class="mui-col-xs-3 mui-col-sm-3">
                    <p>核销门店: </p>
                </div>
                <div class="mui-col-xs-9 mui-col-sm-9">
                    <span style="color: sandybrown" id="card_hexiao_store"></span>
                </div>
            </div>
            <!-- 有效日期 -->
            <div class="mui-row">
                <div class="mui-col-xs-3 mui-col-sm-3">
                    <p>有效日期: </p>
                </div>
                <div class="mui-col-xs-9 mui-col-sm-9">
                    <span style="color: sandybrown" id="card_day"></span>
                </div>
            </div>
            <!-- 使用条件 满多少元可用 -->
            <div class="mui-row">
                <div class="mui-col-xs-3 mui-col-sm-3">
                    <p>使用条件: </p>
                </div>
                <div class="mui-col-xs-9 mui-col-sm-9">
                    <span style="color: sandybrown" id="card_money_usable">订单满200元可用</span>
                </div>
            </div>
            <!-- 使用说明 -->
            <div class="mui-row">
                <div class="mui-col-xs-3 mui-col-sm-3">
                    <p>使用说明: </p>
                </div>
                <div class="mui-col-xs-9 mui-col-sm-9">
                    <span style="color: sandybrown" id="card_details"></span>
                </div>
            </div>
            <div style="width: 100%; text-align: center;padding-top: 10px;border-top: #ccc 1px solid"
                id="card_Jurisdiction">
                <button style="background-color:#007aff;color: white;" id="receive_card">立即抢券</button>
            </div>
        </div>
    </div>
    </div>

    <!-- 照片显示 -->
    <div style="width: 100%; height: 100%; background-color: rgba(60, 63, 63, 0.493);position: absolute; z-index: 2;top: 0px;"
        id="show_qunyu" class="dsplay">
        <div id="show_div">
            <!-- <img src="" alt="" id="show_img"> -->

        </div>
    </div>
</body>
<script>



    // var vConsole = new VConsole();
    var window_location_href = window.location.href; //地址
    var company_href = decodeURIComponent(getQueryVariable('company'));
    var array = company_href.split("_");
    var company = array[0]; //公司名
    var code = array[1]; //卡劵号
    var dislpay_type = array[2]; //类型 0未领取 1领取
    var statt_code = array[3]; //员工号
    // 微信认证


    var locaton = window.location.href;
    // console.log(locaton);

    $.cookie("company", company, {
        path: "/"
    });
    $.cookie('locaton', locaton, {
        path: '/'
    });

    (function () {
        let openId = $.cookie('myself_openid_' + company);
        let nickname = $.cookie('myself_nick_name_' + company);
        let headImgUrl = $.cookie('myself_head_image_' + company);
        //openId = 'o9osQwUghKSMhf1ZGF3oclpiEvtc';
        if ((openId == null) || (openId == "") || (openId == undefined) || (openId == "undefined")) {
            location.href = "https://wxauth.suokeduo.com/card/snsapi_userinfo/forword?redirect_url=" + locaton + '&company= ' +
                company;
        } else {
            $.cookie("openId", openId, { path: '/', expires: 1 });
            $.cookie("nickname", nickname, { path: '/', expires: 1 });
            $.cookie("headImgUrl", headImgUrl, { path: '/', expires: 1 });
        }
    })();

    // 获取公司名称
    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) {
                return pair[1];
            }
        }
        return (false);
    }
</script>
<script>

    var load = new Loading();
    load.init();
    //修改数据库
    modify_mysql();
    function modify_mysql() {
        mui.post('/index.php/dataBase/', {
            database: company,
        }, function (data) {
            //服务器返回响应，根据响应结果，分析是否登录成功；
        }, 'json');
    }

</script>
<script>
    var card_type = "";
    var coupon_code = "";
    var staff_code = "";
    // 点击领取卡卷
    document.getElementById("receive_card").onclick = function () {
        load.start();
        mui.post('/index.php/GiveCouponReceive/', {
            card_type: card_type,//类型
            coupon_code: coupon_code,//code
            staff_code: staff_code,//员工code
            openid: $.cookie("openId")
        }, function (data) {
            //服务器返回响应，根据响应结果，分析是否登录成功；
            if (data.code == 200) {

                // localStorage.setItem("card_yanzheng", code+'true');
                mui.toast('领取成功', {
                    duration: 'long',
                    type: 'div'
                })
                document.getElementById("receive_card").innerHTML = '卡劵已领取';
                document.getElementById("receive_card").style.backgroundColor = '#ccc';
            } else if (data.code == 300) {
                // localStorage.setItem("card_yanzheng", code + 'true');

                mui.toast(data.msg, {
                    duration: 'long',
                    type: 'div'
                })
                document.getElementById("receive_card").innerHTML = '卡劵已领取';
                document.getElementById("receive_card").style.backgroundColor = '#ccc';
            } else if (data.code == 400) {
                mui.toast(data.msg, {
                    duration: 'long',
                    type: 'div'
                })
            }
            load.stop();
        }, 'json'
        );
    }

    window_load()
    // 根据传参判断 type=1没有领取卡卷权限
    function window_load() {
        if (dislpay_type != 0 || dislpay_type != "0") {
            document.getElementById("card_Jurisdiction").classList.add('dsplay');
            document.getElementById("display_card").classList.add('dsplay');
            // document.getElementById("display_store").classList.add('dsplay');
        }

        // 跟据传的code进行卡劵查询
        get_card();
        // card_yanzheng();
    }

    // 根据卡劵查询
    
    function get_card() {
        load.start();
        mui.post('/index.php/GiveCouponDetails/', {
            coupon_code: code,//传参的code值
            staff_code: statt_code
        }, function (data) {
            //服务器返回响应，根据响应结果，分析是否登录成功；
            if (data.code == 200) {
                card_type = data.data.card_type;
                coupon_code = data.data.code;
                staff_code = data.data.staff_code;

                // 给回显图片传路径
                var src_g = './../../images/zw.jpg';
                // mui("#card_money")[0].innerHTML = data.data.card_money;
                if ((data.data.img == "") || (data.data.img == " ") || (data.data.img == null) || (data.data.img == undefined)) {
                    mui("#bg_img")[0].style.backgroundImage = 'url(./../../images/zw.jpg)';
                    src_g = './../../images/zw.jpg';
                } else {
                    if (data.data.img.indexOf("http") != -1) {
                        src_g = data.data.img
                    } else {
                        src_g = 'http://vip.suokeduo.com' + data.data.img
                    }
                    mui("#bg_img")[0].style.backgroundImage = 'url( ' + src_g + ')';
                }

                document.getElementById("show_div").innerHTML = '"<img src="' + src_g + '" alt="" id="show_img">"';
                // 赋值
                mui("#card_type")[0].innerHTML = data.data.type;
                mui("#card_name")[0].innerHTML = data.data.name;
                mui("#card_number")[0].innerHTML = data.data.already_number;
                // mui("#card_store")[0].innerHTML = data.data.store_name;
                
                mui("#card_money_usable")[0].innerHTML = data.data.money;
                mui("#card_day")[0].innerHTML = data.data.day_time;
                mui("#card_details")[0].innerHTML = data.data.remark;
                if (data.data.card_type == 0) {
                    // 优惠券
                    mui("#display_card_money")[0].classList.remove('dsplay');
                    mui("#card_money")[0].innerHTML = data.data.coupon_name;
                } else if (data.data.card_type == 1) {
                    // 折扣
                    mui("#display_card_zhekou")[0].classList.remove('dsplay');
                    mui("#card_zhekou")[0].innerHTML = data.data.coupon_name;
                } else if (data.data.card_type == 2) {
                    // 礼品卷
                    mui("#display_card_lipin")[0].classList.remove('dsplay');
                    mui("#card_lipin")[0].innerHTML = data.data.coupon_name;
                }

                if (dislpay_type == 2 || dislpay_type == "2") {
                    mui("#card_hexiao_store")[0].innerHTML = data.data.off_name; //类型 0普通卡劵 1赠送卡劵 2核销卡劵

                } else {
                    mui("#card_hexiao_store")[0].innerHTML = data.data.off_store_name; //类型 0普通卡劵 1赠送卡劵 2核销卡劵
                }

                load.stop();
            }
        }, 'json'
        );
    }

// 进行判断是否已经领取过卡劵

//  function card_yanzheng(){
//      if(localStorage.getItem("card_yanzheng") == code+'true'){
//         //卡劵已经领取
//          document.getElementById("receive_card").innerHTML = '卡劵已领取';
//          document.getElementById("receive_card").style.backgroundColor = '#ccc';
//      }
//  }


</script>
<script>
    $("#bg_img").click(function () {
        // 给回显图片传入路径
        document.getElementById("show_qunyu").classList.remove('dsplay');
        // 照片
        // var img = document.getElementById("show_img");
        var show_div = document.getElementById("show_div");

        var windowW = $(window).width();//获取当前窗口宽度  
        var windowH = $(window).height();//获取当前窗口高度  

        var realWidth = document.getElementById("show_img").width;//获取图片真实宽度  
        var realHeight = document.getElementById("show_img").height;//获取图片真实高度  

        var imgWidth, imgHeight;

        var scale = 1;//缩放尺寸，当图片真实宽度和高度大于窗口宽度和高度时进行缩放  

        if (realHeight > windowH * scale) {//判断图片高度  
            imgHeight = windowH * scale;//如大于窗口高度，图片高度进行缩放  
            imgWidth = imgHeight / realHeight * realWidth;//等比例缩放宽度  
            if (imgWidth > windowW * scale) {//如宽度扔大于窗口宽度  
                imgWidth = windowW * scale;//再对宽度进行缩放  
            }
        } else if (realWidth > windowW * scale) {//如图片高度合适，判断图片宽度  
            imgWidth = windowW * scale;//如大于窗口宽度，图片宽度进行缩放  
            imgHeight = imgWidth / realWidth * realHeight;//等比例缩放高度  
        } else {//如果图片真实高度和宽度都符合要求，高宽不变  
            imgWidth = realWidth;
            imgHeight = realHeight;
        }

        document.getElementById("show_img").style.width = imgWidth + 'px';//以最终的宽度对图片缩放  
        var w = (windowW - imgWidth) / 2;//计算图片与窗口左边距  
        var h = (windowH - imgHeight) / 2;//计算图片与窗口上边距  

        show_div.style.marginTop = h + 'px';
        show_div.style.marginLeft = w + 'px';
    })


    $("#show_qunyu").click(function () {
        document.getElementById("show_qunyu").classList.add('dsplay');
    })
</script>
<!-- // $(function () {
    //     // $.cookie("wx_user", "");
    //     var cookieJSON = $.cookie(decodeURIComponent(getQueryVariable("company")) + "_openId") ? $.cookie(decodeURIComponent(getQueryVariable("company")) + "_openId") : "";
    //     if (cookieJSON == "" || cookieJSON == " " || cookieJSON == undefined || cookieJSON == 'undefined') {
    //         $.ajax({
    //             type: 'GET',
    //             dataType: 'JSONP',
    //             url: 'https://wxauth.suokeduo.com/card/snsapi_userinfo/index?company=' + company,
    //             //需要页面传入值
    //             success: function (data) {
    //                 // console.log(JSON.stringify(data));
    //                 // $.cookie("wx_user", data, 10000);
    //                 //这获取到用户的信息了；把这个信息放到cookie中
    //                 $.cookie(decodeURIComponent(getQueryVariable("company")) + "_openId", data['openId'], { path: '/' }, 10000);
    //                 $.cookie("openId", data['openId'], { path: '/' }, 10000);
    //                 $.cookie("Img", data['headImgUrl'], { path: '/' }, 10000);
    //             },
    //             error: function (data) {
    //                 location.href = "https://wxauth.suokeduo.com/card/snsapi_userinfo/forword?redirect_url=" + window_location_href + '&company=' + company;
    //             }
    //         })
    //     }else{
    //         $.cookie("openId", $.cookie(decodeURIComponent(getQueryVariable("company")) + "_openId"), { path: '/' }, 10000);
    //     }
    // }); -->

</html>